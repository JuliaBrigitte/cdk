#!/usr/bin/env bash

set -e

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
ROOT_DIR=$DIR/..

preamble() {
  "${DIR}"/check-yarn-lock
  "${DIR}"/check-aws-cdk
}

runIntegrationTest() {
  (
    cd "$ROOT_DIR/tools/integration-test"
    ./script/ci
  )
}

keepReadmeUpdated() {
  "${DIR}"/cli-docs

  if git diff --quiet; then
    exit 0
  else
    echo "The CLI docs in README.md are out of date. Run './script/cli-docs' to update them."
    exit 1
  fi
}

main() {
  preamble

  npm ci
  npm run build
  npm run lint
  npm run test:custom-lint-rule
  npm run test

  runIntegrationTest
  keepReadmeUpdated
}

main
